#-------------------------------------------------------------------------
#   rxtx is a native interface to serial ports in java.
#   Copyright 1997, 1998, 1999 by Trent Jarvi trentjarvi@yahoo.com.
#
#   This library is free software; you can redistribute it and/or
#   modify it under the terms of the GNU Library General Public
#   License as published by the Free Software Foundation; either
#   version 2 of the License, or (at your option) any later version.
#
#   This library is distributed in the hope that it will be useful,
#   but WITHOUT ANY WARRANTY; without even the implied warranty of
#   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
#   Library General Public License for more details.
#
#   You should have received a copy of the GNU Library General Public
#   License along with this library; if not, write to the Free
#   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA
#-------------------------------------------------------------------------
WJI= -I @WINDOWS_JAVA_INCLUDE@ -I @WINDOWS_JAVA_INCLUDE@/win32 
AUTOMAKE_OPTIONS = foreign
TOP=@TOP@
JPATH=@JPATH@
JCL_PATH=@JCL_PATH@
INCLUDES= -I $(TOP) -I $(TOP)/$(target_alias) -I . -I $(JAVAINCLUDE) -I $(JAVANATINC)
export NSJAVA=1
export THREADS_FLAG=@THREAD_FLAG@
JAVAC=$(JPATH)/bin/javac $(JCLASSPATH):$(COMM_JAR_PATH):$(JCL_JAR_PATH) -d $(TOP)/ -O 
JAVAH=$(JPATH)/bin/javah $(JAVA_H_CLASSPATH) -d $(TOP)/$(target_alias) -jni
JAVA=$(JPATH)/bin/java $(JCLASSPATH)
JAR=$(JPATH)/bin/jar 
JAVADOC=$(JPATH)/bin/javadoc $(JCLASSPATH)
LIBTOOL = $(SHELL) $(TOP)/libtool
LINK = $(LIBTOOL) --mode=link $(CC) $(CFLAGS) $(LDFLAGS) -version-info 1:0:1
SERIAL_HEADER = $(TOP)/$(target_alias)/gnu_io_RXTXPort.h $(TOP)/$(target_alias)/gnu_io_RXTXCommDriver.h
PARALLEL_HEADER = $(TOP)/$(target_alias)/gnu_io_LPRPort.h
CLEANFILES = $(TOP)/*.class $(TOP)/gnu/io/*.class $(TOP)/jcl.jar
#LTLIBRARIES =     $(lib_LTLIBRARIES)
#BUILT_SOURCES = $(TOP)/$(target_alias)/libSerial.la
SUFFIXES = .java .class
SUFFIXES = .class .h

install: all jcl install-lib

clean-generic:
	rm -rf $(TOP)/$(target_alias) $(TOP)/gnu 
	-test -z "$(CLEANFILES)" || rm -f $(CLEANFILES)
	@echo -e "\n\nMake distclean will remove the remaining files\n\n"
install-lib:
	( cd $(TOP)/$(target_alias) ; \
	if [ -f libSerial.la ];then \
	$(LIBTOOL) --mode=install $(INSTALL_PROGRAM) libSerial.la $(RXTX_PATH);\
	fi; \
	if [ -f libParallel.la ];then \
	$(LIBTOOL) --mode=install $(INSTALL_PROGRAM) libParallel.la $(RXTX_PATH);\
	fi; \
	)
	$(INSTALL_PROGRAM) jcl.jar $(JPATH)/$(JCL_PATH)/
run: $(TOP)/test.class all jcl
	(cd $(TOP)/;chmod 755 *.class;\
	LD_LIBRARY_PATH="$(target_alias)";\
	export LD_LIBRARY_PATH;\
	$(JAVA) test)

all: @IDENTIFIERS@ @TARGETLIB@
	@echo -e "\n\nIf you have javax.comm.* and java.comm.* in your CLASSPATH, type make jcl to"
	@echo -e "build the javacomm20-x86.tar.Z supporting classes.\n"
	@echo "Note: CLASSPATH was grabbed during the configure stage.  Modification of the"
	@echo "environment variable will not change the behavior of make without rerunning" 
	@echo  -e "configure or editing the Makefile. \n"

jcl:  $(TOP)/gnu/io/RXTXCommDriver.class $(TOP)/gnu/io/RXTXPort.class $(TOP)/gnu/io/RXTXPort.class @IDENTIFIERS@
	$(JAR) cf jcl.jar gnu/io/*
	@echo "make install will install RxTx"

$(TOP)/gnu/io/RXTXCommDriver.class $(TOP)/gnu/io/RXTXPort.class \
		$(TOP)/gnu/io/LPRPort.class \
		: $(srcdir)/src/RXTXCommDriver.java \
		$(srcdir)/src/LPRPort.java \
		$(srcdir)/src/RXTXPort.java 
# handle java quirks here.
	$(JAVAH_FIX) \
	$(JAVAC) $(srcdir)/src/RXTXPort.java $(srcdir)/src/LPRPort.java $(srcdir)/src/RXTXCommDriver.java

$(TOP)/$(target_alias)/libParallel.la: $(TOP)/$(target_alias)/ParallelImp.lo
	( cd $(TOP)/$(target_alias); \
	$(LINK) -o libParallel.la -rpath $(RXTX_PATH) $(<F); \
	for I in .libs/*.so*;do cp $$I . ;done;)

$(TOP)/$(target_alias)/ParallelImp.lo: $(srcdir)/src/ParallelImp.c \
                                  $(PARALLEL_HEADER) \
				  $(TOP)/Makefile
	(cd $(TOP)/$(target_alias); \
	$(LIBTOOL) --mode=compile $(CC) $(INCLUDES) $(CPPFLAGS) $(CFLAGS) @VERBOSE_IOEXCEPTIONS@ -c ../$< )

$(TOP)/$(target_alias)/libSerial.la: $(TOP)/$(target_alias)/SerialImp.lo
	( cd $(TOP)/$(target_alias); \
	$(LINK) -o libSerial.la -rpath $(RXTX_PATH) $(<F); \
	for I in .libs/*.so*;do cp $$I . ;done;)

$(TOP)/$(target_alias)/SerialImp.lo: $(srcdir)/src/SerialImp.c \
                                  $(SERIAL_HEADER) \
				  $(TOP)/Makefile
	(cd $(TOP)/$(target_alias); \
	$(LIBTOOL) --mode=compile $(CC) $(INCLUDES) $(CPPFLAGS) $(CFLAGS) @VERBOSE_IOEXCEPTIONS@ -c ../$< )

$(TOP)/%.class $(TOP)/gnu/io/%.class: $(srcdir)/src/%.java 
	$(JAVAC) $< 

$(SERIAL_HEADER) $(PARALLEL_HEADER): $(TOP)/gnu/io/RXTXPort.class
	$(JAVAH) gnu.io.`echo $(@F) | sed s#\.h##|sed s#gnu_io_##`
	touch $(TOP)/$(target_alias)/$(@F)

borg: $(TOP)/gnu/io/RXTXCommDriver.class $(TOP)/gnu/io/RXTXPort.class $(TOP)/gnu/io/LPRPort.class $(SERIAL_HEADER)
	gcc -DWIN32 -D  __int64="long long"  -mno-fp-ret-in-387 -b$(target_alias) -I $(TOP) -I $(TOP)/$(target_alias) -I . $(WJI) -I ../src/ -Wall -c ../src/SerialImp.c -o  $(TOP)/$(target_alias)/SerialImp.o
	gcc -DWIN32 -D  __int64="long long"  -mno-fp-ret-in-387 -b$(target_alias) -I $(TOP) -I $(TOP)/$(target_alias) -I . $(WJI) -I ../src/ -Wall -c ../src/termios.c -o  $(TOP)/$(target_alias)/termios.o
	gcc -DWIN32 -D  __int64="long long"  -mno-fp-ret-in-387 -b$(target_alias) -I $(TOP) -I $(TOP)/$(target_alias) -I . $(WJI) -I ../src/ -Wall -c ../src/fixup.c -o  $(TOP)/$(target_alias)/fixup.o
	gcc -DWIN32 -D  __int64="long long"  -mno-fp-ret-in-387 -b$(target_alias) -I $(TOP) -I $(TOP)/$(target_alias) -I . $(WJI) -I ../src/ -Wall -c ../src/init.cc -o  $(TOP)/$(target_alias)/init.o
	ld --base-file $(target_alias)/Serial.base  --dll -o  $(target_alias)/Serial.dll $(target_alias)/termios.o $(target_alias)/SerialImp.o $(target_alias)/fixup.o $(target_alias)/init.o  -luser32 -lgdi32 -lcomdlg32 -lkernel32 -ladvapi32 -lmingw32 -lmoldname -lcrtdll -e _dll_entry@12 --base-file $(target_alias)/Serial.base
	dlltool  -b$(target_alias) --as=as --dllname $(target_alias)/Serial.dll  --def ../src/Serial.def --base-file $(target_alias)/Serial.base --output-exp $(target_alias)/Serial.exp
	ld --base-file $(target_alias)/Serial.base $(target_alias)/Serial.exp -dll -o  $(target_alias)/Serial.dll $(target_alias)/termios.o $(target_alias)/SerialImp.o $(target_alias)/fixup.o $(target_alias)/init.o  -luser32 -lgdi32 -lcomdlg32 -lkernel32 -ladvapi32 -lmingw32 -lmoldname -lcrtdll -e _dll_entry@12 --base-file $(target_alias)/Serial.base
	dlltool   -b$(target_alias) --as=as --dllname $(target_alias)/Serial.dll  --def ../src/Serial.def --base-file $(target_alias)/Serial.base --output-exp $(target_alias)/Serial.exp
	ld $(target_alias)/Serial.exp -dll -o  $(target_alias)/Serial.dll $(target_alias)/termios.o $(target_alias)/SerialImp.o $(target_alias)/fixup.o $(target_alias)/init.o  -luser32 -lgdi32 -lcomdlg32 -lkernel32 -ladvapi32 -lmingw32 -lmoldname -lcrtdll -e _dll_entry@12 --base-file $(target_alias)/Serial.base

docs:
	mkdir gnu;
	cd gnu;ln -s $(srcdir)/src io
	cd ..
	rm -rf gnu

# END
